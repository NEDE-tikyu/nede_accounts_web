<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚¨ãƒãƒ«ã‚®ãƒ¼ç ”ç©¶ä¼š ç™ºæ³¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f7f6; line-height: 1.6; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border: 1px solid transparent; border-bottom: none; transition: 0.3s; }
        .tab.active { background: #007bff; color: white; border-radius: 5px 5px 0 0; font-weight: bold; }
        
        .btn-group { margin: 15px 0; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        button { padding: 8px 14px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold; transition: 0.3s; font-size: 0.9em; }
        .btn-load { background: #007bff; }
        .btn-excel { background: #28a745; }
        .btn-catalog { background: #17a2b8; }
        .btn-upload { background: #6f42c1; font-size: 0.85em; padding: 8px 12px; }
        .btn-save-name { background: #495057; }
        
        .btn-sm { padding: 4px 8px; font-size: 0.8em; }
        .btn-open { background: #17a2b8; }
        .btn-approve { background: #28a745; }
        .btn-reject { background: #dc3545; }
        .btn-reorder { background: #6f42c1; }

        button:hover { opacity: 0.8; }
        
        #status-msg { font-weight: bold; color: #d9534f; padding: 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
        .template-status { font-size: 11px; margin-left: 5px; color: #666; }
        .status-ok { color: #28a745; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f8f9fa; }
        .badge { font-size: 10px; padding: 2px 5px; border-radius: 3px; background: #e9ecef; margin-right: 2px; color: #666; border: 1px solid #ccc; white-space: nowrap; }
        
        .setup-area { background: #eef9ff; border: 2px dashed #007bff; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .bookmark-btn { display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 50px; font-weight: bold; cursor: move; }
        input[type="text"], input[type="number"] { padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ã‚¨ãƒãƒ«ã‚®ãƒ¼ç ”ç©¶ä¼š ç™ºæ³¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  PRO</h1>
    <p id="status-msg">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æº–å‚™å®Œäº†</p>

    <div class="setup-area">
        <strong>ã€è¨­å®šã€‘</strong> ã“ã®ãƒœã‚¿ãƒ³ã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒãƒ¼ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼
        <br><br>
        <a id="bookmarkletLink" href="" class="bookmark-btn">ğŸ“¦ å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—</a>
    </div>

    <div class="tabs">
        <div id="tab-before" class="tab active" onclick="switchTab('before')">ç™ºæ³¨å‰ (æœªå®Œäº†)</div>
        <div id="tab-after" class="tab" onclick="switchTab('after')">ç™ºæ³¨æ¸ˆã¿ (å±¥æ­´)</div>
    </div>

    <div id="accountant-area" class="btn-group" style="background:#f8f9fa; padding:10px; border-radius:5px; border:1px solid #eee;">
        <strong>ä¼šè¨ˆæ‹…å½“è€…:</strong> 
        <input type="text" id="accountantName" placeholder="æ°åã‚’å…¥åŠ›">
        <button class="btn-save-name" onclick="saveAccountantName()">ä¿å­˜</button>
    </div>

    <div class="btn-group" style="background:#f1f3f5; padding:15px; border-radius:8px;">
        <div style="width:100%; margin-bottom:5px;"><strong>ğŸ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®š</strong></div>
        <div>
            <button class="btn-upload" onclick="document.getElementById('inputReq').click()">ç™ºæ³¨è¡¨æ›´æ–°</button>
            <input type="file" id="inputReq" style="display:none" accept=".xlsx" onchange="handleTemplateUpload(this, 'excel_template')">
            <span id="stReq" class="template-status">æœªè¨­å®š</span>
        </div>
        <div>
            <button class="btn-upload" onclick="document.getElementById('inputCat').click()">ã‚«ã‚¿ãƒ­ã‚°æ›´æ–°</button>
            <input type="file" id="inputCat" style="display:none" accept=".xlsx" onchange="handleTemplateUpload(this, 'catalog_template')">
            <span id="stCat" class="template-status">æœªè¨­å®š</span>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn-load" onclick="loadItems()">ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button>
        <button class="btn-excel" onclick="exportFromTemplate()">ç™ºæ³¨ä¾é ¼è¡¨ (Excel)</button>
        <button class="btn-catalog" onclick="exportCatalog()">ã‚«ã‚¿ãƒ­ã‚° (Excel)</button>
    </div>

    <table id="itemTable">
        <thead><tr id="tableHead"></tr></thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwQSUME_UlBmI4E5MrV6b0wAkFYr0angHCVlhjWa-f1xkA54u8gB518cNeqzk7YncAcgg/exec"; 
    
    let allData = [];
    let currentTab = 'before';
    let cachedRequestTemplate = null;
    let cachedCatalogTemplate = null;

    // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆEscã‚­ãƒ¼ä¸­æ–­ãƒ»å‹å¼ã‚¹ã‚­ãƒƒãƒ—å¯¾å¿œç‰ˆï¼‰
    const bml = `javascript:(function(){const gasUrl='${GAS_URL}';const fields=['å“å','å‹å¼','å˜ä¾¡','ãƒ¡ãƒ¼ã‚«ãƒ¼'];let results={};let currentStep=0;let lastText='';const panel=document.createElement('div');panel.style='position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:2147483647;background:#222;color:#00ffcc;padding:20px;border-radius:12px;font-family:sans-serif;box-shadow:0 10px 40px rgba(0,0,0,0.8);border:2px solid #00ffcc;text-align:center;min-width:300px;';document.body.appendChild(panel);const update=()=>{const skipMsg=fields[currentStep]==='å‹å¼'?'<br><span style="color:#ffcc00;font-size:11px;">â€»ç„¡ã„å ´åˆã¯ãã®ã¾ã¾Enterã§ã‚¹ã‚­ãƒƒãƒ—</span>':'';panel.innerHTML=\`<div style='font-size:12px;color:#888;'>STEP \${currentStep+1}/\${fields.length}</div><div style='font-size:20px;margin:10px 0;font-weight:bold;'>ã€Œ\${fields[currentStep]}ã€ã‚’é¸æŠã—ã¦Enter</div>\${skipMsg}<div style='font-size:12px;color:#aaa;margin-top:10px;'>Escã‚­ãƒ¼ã§ä¸­æ–­</div>\`};const style=document.createElement('style');style.innerHTML='.gas-target{outline:2px solid #00ffcc !important;background:rgba(0,255,204,0.1) !important;}';document.head.appendChild(style);const onOver=(e)=>e.target.classList.add('gas-target');const onOut=(e)=>e.target.classList.remove('gas-target');const onClick=(e)=>{e.preventDefault();e.stopPropagation();lastText=e.target.innerText.trim()};document.addEventListener('mouseover',onOver);document.addEventListener('mouseout',onOut);document.addEventListener('click',onClick);const cleanup=()=>{document.removeEventListener('mouseover',onOver);document.removeEventListener('mouseout',onOut);document.removeEventListener('click',onClick);window.removeEventListener('keydown',onKey);panel.remove()};const onKey=(e)=>{if(e.key==='Escape'){cleanup();return}if(e.key==='Enter'){const sel=window.getSelection().toString().trim();const val=sel||lastText;results[fields[currentStep]]=val||'';currentStep++;if(currentStep<fields.length){lastText='';update()}else{finish()}}};window.addEventListener('keydown',onKey);function finish(){panel.innerHTML='é€ä¿¡ä¸­...';fetch(gasUrl,{method:'POST',mode:'no-cors',body:JSON.stringify({action:'update_from_browser',url:window.location.href,data:results})}).then(()=>{panel.style.background='#006633';panel.innerHTML='åæ˜ å®Œäº†ï¼';setTimeout(cleanup,2000)})};update()})();`;
    document.getElementById('bookmarkletLink').href = bml;

    window.onload = () => {
        const savedName = localStorage.getItem('accountant_name');
        if (savedName) document.getElementById('accountantName').value = savedName;
        const savedReq = localStorage.getItem('excel_template');
        if (savedReq) { cachedRequestTemplate = base64ToArrayBuffer(savedReq); document.getElementById('stReq').innerHTML = '<span class="status-ok">âœ” ä¿å­˜æ¸ˆ</span>'; }
        const savedCat = localStorage.getItem('catalog_template');
        if (savedCat) { cachedCatalogTemplate = base64ToArrayBuffer(savedCat); document.getElementById('stCat').innerHTML = '<span class="status-ok">âœ” ä¿å­˜æ¸ˆ</span>'; }
        loadItems();
    };

    function saveAccountantName() {
        localStorage.setItem('accountant_name', document.getElementById('accountantName').value);
        alert("åå‰ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    }

    function switchTab(tab) {
        currentTab = tab;
        document.getElementById('tab-before').className = tab === 'before' ? 'tab active' : 'tab';
        document.getElementById('tab-after').className = tab === 'after' ? 'tab active' : 'tab';
        renderTable();
    }

    async function loadItems() {
        document.getElementById('status-msg').innerText = "èª­ã¿è¾¼ã¿ä¸­...";
        try {
            const resp = await fetch(`${GAS_URL}?action=get_all`);
            allData = await resp.json();
            renderTable();
            document.getElementById('status-msg').innerText = "èª­è¾¼å®Œäº†";
        } catch (e) { document.getElementById('status-msg').innerText = "èª­è¾¼ã‚¨ãƒ©ãƒ¼"; }
    }

    function renderTable() {
        const head = document.getElementById('tableHead');
        const body = document.getElementById('tableBody');
        body.innerHTML = "";
        
        if (currentTab === 'before') {
            head.innerHTML = "<th>æŠ•ç¨¿è€…</th><th>å•†å“æƒ…å ±</th><th>å€‹æ•°</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th>";
            const filtered = allData.filter(i => i.status !== 'å´ä¸‹' && !(i.status.includes("æ‰¿èªæ¸ˆ") && i.status.includes("ç™ºæ³¨ä¾é ¼è¡¨ä½œæˆæ¸ˆã¿") && i.status.includes("ã‚«ã‚¿ãƒ­ã‚°ä½œæˆæ¸ˆã¿")));
            filtered.reverse().forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.user}</td>
                    <td><b>${item.itemName || '-'}</b><br><small>${item.model || '(å‹å¼ãªã—)'} / Â¥${item.price}</small></td>
                    <td><input type="number" id="qty-${item.row}" value="${item.qty}" style="width:45px"></td>
                    <td>${item.status.split(',').map(s=>`<span class="badge">${s}</span>`).join('')}</td>
                    <td>
                        <button class="btn-sm btn-open" style="background:#17a2b8;" onclick="window.open('${item.url}')">é–‹ã</button>
                        <button class="btn-sm btn-approve" style="background:#28a745;" onclick="updateStatus(${item.row}, 'æ‰¿èªæ¸ˆ')">æ‰¿èª</button>
                        <button class="btn-sm btn-reject" style="background:#dc3545;" onclick="updateStatus(${item.row}, 'å´ä¸‹')">å´ä¸‹</button>
                    </td>
                `;
                body.appendChild(tr);
            });
        } else {
            head.innerHTML = "<th>å“å</th><th>å‹å¼</th><th>å˜ä¾¡</th><th>å€‹æ•°</th><th>æ“ä½œ</th>";
            const filtered = allData.filter(i => i.status.includes("æ‰¿èªæ¸ˆ") && i.status.includes("ç™ºæ³¨ä¾é ¼è¡¨ä½œæˆæ¸ˆã¿") && i.status.includes("ã‚«ã‚¿ãƒ­ã‚°ä½œæˆæ¸ˆã¿"));
            filtered.reverse().forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.itemName}</td>
                    <td>${item.model || '-'}</td>
                    <td>Â¥${item.price}</td>
                    <td><input type="number" id="rqty-${item.row}" value="${item.qty}" style="width:45px"></td>
                    <td><button class="btn-sm btn-reorder" onclick="reorder(${item.row})">å†ç™ºæ³¨</button></td>
                `;
                body.appendChild(tr);
            });
        }
    }

    async function updateStatus(row, status) {
        const qtyInput = document.getElementById(`qty-${row}`);
        const qty = qtyInput ? qtyInput.value : 1;
        document.getElementById('status-msg').innerText = "æ›´æ–°ä¸­...";
        await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "update_status", row: row, status: status, qty: qty }) });
        loadItems();
    }

    async function reorder(row) {
        const item = allData.find(i => i.row === row);
        const qty = document.getElementById(`rqty-${row}`).value;
        await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "reorder", user: "å†ç™ºæ³¨", url: item.url, qty: qty, itemName: item.itemName, model: item.model, price: item.price, maker: item.maker }) });
        alert("è¿½åŠ ã—ã¾ã—ãŸ");
        loadItems();
    }

    async function handleTemplateUpload(input, key) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const buffer = e.target.result;
            if(key==='excel_template') cachedRequestTemplate = buffer; else cachedCatalogTemplate = buffer;
            localStorage.setItem(key, arrayBufferToBase64(buffer));
            document.getElementById(key === 'excel_template' ? 'stReq' : 'stCat').innerHTML = '<span class="status-ok">âœ” ä¿å­˜æ¸ˆ</span>';
            alert("æ›´æ–°ã—ã¾ã—ãŸ");
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    async function exportFromTemplate() {
        if (!cachedRequestTemplate) return alert("ç™ºæ³¨è¡¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„");
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(cachedRequestTemplate);
        const sheet = workbook.getWorksheet('ã‚¨ãƒãƒ«ã‚®ãƒ¼ç ”');
        if(!sheet) return alert("ã‚·ãƒ¼ãƒˆã€Œã‚¨ãƒãƒ«ã‚®ãƒ¼ç ”ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

        for(let r=13; r<=22; r++) {
            sheet.getRow(r).getCell(1).value = null;
            for(let c=3; c<=7; c++) sheet.getRow(r).getCell(c).value = null;
        }

        const approved = allData.filter(i => i.status.includes("æ‰¿èªæ¸ˆ"));
        const updates = [];
        approved.slice(0, 10).forEach((item, i) => {
            const r = 13 + i;
            sheet.getCell(`A${r}`).value = new Date().toLocaleDateString();
            sheet.getCell(`C${r}`).value = item.itemName;
            sheet.getCell(`D${r}`).value = item.model;
            sheet.getCell(`E${r}`).value = Number(item.price);
            sheet.getCell(`F${r}`).value = Number(item.qty);
            sheet.getCell(`G${r}`).value = item.maker;
            let s = item.status;
            if(!s.includes("ç™ºæ³¨ä¾é ¼è¡¨ä½œæˆæ¸ˆã¿")) s += (s ? "," : "") + "ç™ºæ³¨ä¾é ¼è¡¨ä½œæˆæ¸ˆã¿";
            updates.push({ row: item.row, status: s });
        });
        await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "update_status_multi", updates: updates }) });
        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), `ç™ºæ³¨ä¾é ¼è¡¨_${new Date().toLocaleDateString()}.xlsx`);
        loadItems();
    }

    async function exportCatalog() {
        if (!cachedCatalogTemplate) return alert("ã‚«ã‚¿ãƒ­ã‚°ã®ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„");
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(cachedCatalogTemplate);
        const sheet = workbook.getWorksheet(1);

        for(let r=3; r<=16; r++) {
            for(let c=3; c<=8; c++) sheet.getRow(r).getCell(c).value = null;
        }

        const approved = allData.filter(i => i.status.includes("æ‰¿èªæ¸ˆ"));
        const updates = [];
        approved.slice(0, 14).forEach((item, i) => {
            const r = 3 + i;
            sheet.getCell(`C${r}`).value = item.itemName;
            sheet.getCell(`D${r}`).value = item.model;
            sheet.getCell(`E${r}`).value = Number(item.price);
            sheet.getCell(`F${r}`).value = Number(item.qty);
            sheet.getCell(`G${r}`).value = item.maker;
            sheet.getCell(`H${r}`).value = item.url;
            let s = item.status;
            if(!s.includes("ã‚«ã‚¿ãƒ­ã‚°ä½œæˆæ¸ˆã¿")) s += (s ? "," : "") + "ã‚«ã‚¿ãƒ­ã‚°ä½œæˆæ¸ˆã¿";
            updates.push({ row: item.row, status: s });
        });
        await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "update_status_multi", updates: updates }) });
        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), `ã‚«ã‚¿ãƒ­ã‚°_${new Date().toLocaleDateString()}.xlsx`);
        loadItems();
    }

    function arrayBufferToBase64(b){let s='';const y=new Uint8Array(b);for(let i=0;i<y.byteLength;i++)s+=String.fromCharCode(y[i]);return window.btoa(s);}
    function base64ToArrayBuffer(s){const b=window.atob(s);const l=b.length;const y=new Uint8Array(l);for(let i=0;i<l;i++)y[i]=b.charCodeAt(i);return y.buffer;}
</script>
</body>
</html>