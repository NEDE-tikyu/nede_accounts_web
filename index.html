<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>エネルギー研究会 発注管理システム PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f7f6; line-height: 1.6; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .btn-group { margin: 15px 0; display: flex; gap: 8px; flex-wrap: wrap; }
        button { padding: 10px 16px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold; transition: 0.3s; }
        .btn-load { background: #007bff; }
        .btn-excel { background: #28a745; }
        .btn-catalog { background: #17a2b8; }
        .btn-upload { background: #6f42c1; }
        .btn-upload-cat { background: #e83e8c; }
        .btn-save-name { background: #495057; }
        button:hover { opacity: 0.8; }
        #status { font-weight: bold; color: #d9534f; padding: 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f8f9fa; position: sticky; top: 0; }
        .approved { background-color: #e9f7ef; }
        .input-area { background: #f1f3f5; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .url-data-info { font-size: 0.8em; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h1>エネルギー研究会 発注管理画面</h1>
    <p id="status">ステータス: 準備完了</p>

    <div class="input-area">
        <strong>会計担当者名:</strong> 
        <input type="text" id="accountantName" placeholder="三宅啓斗" style="padding: 8px; width: 200px;">
        <button class="btn-save-name" onclick="saveAccountantName()">名前を保存</button>
    </div>

    <div class="btn-group">
        <button class="btn-load" onclick="loadItems()">① データ読み込み</button>
        <input type="file" id="templateInput" style="display:none" accept=".xlsx" onchange="handleTemplateUpload(this, 'excel_template')">
        <button class="btn-upload" onclick="document.getElementById('templateInput').click()">② 発注表テンプレ更新</button>
        <input type="file" id="catalogInput" style="display:none" accept=".xlsx" onchange="handleTemplateUpload(this, 'catalog_template')">
        <button class="btn-upload-cat" onclick="document.getElementById('catalogInput').click()">③ カタログテンプレ更新</button>
    </div>

    <div class="btn-group">
        <button class="btn-excel" onclick="exportFromTemplate()">Excel出力 (発注依頼表)</button>
        <button class="btn-catalog" onclick="exportCatalog()">Excel出力 (カタログ)</button>
    </div>

    <table id="itemTable">
        <thead>
            <tr>
                <th>投稿者</th><th>商品詳細 (URLから取得)</th><th>個数</th><th>状態</th><th>操作</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxCfyc-UufJkJBBsesXlsSghPI4V5MsulxSNXTAyyVvVKfdEOZDDS4ck06u1XAykGlU0w/exec"; 
    let allData = [];
    let cachedRequestTemplate = null;
    let cachedCatalogTemplate = null;

    window.onload = () => {
        // 会計担当者の復元
        const savedName = localStorage.getItem('accountant_name');
        if (savedName) document.getElementById('accountantName').value = savedName;
        
        // テンプレートの復元
        const savedReq = localStorage.getItem('excel_template');
        if (savedReq) cachedRequestTemplate = base64ToArrayBuffer(savedReq);
        const savedCat = localStorage.getItem('catalog_template');
        if (savedCat) cachedCatalogTemplate = base64ToArrayBuffer(savedCat);
    };

    function saveAccountantName() {
        const name = document.getElementById('accountantName').value;
        localStorage.setItem('accountant_name', name);
        alert("会計担当者名を保存しました。");
    }

    async function loadItems() {
        document.getElementById('status').innerText = "読み込み中...";
        try {
            const resp = await fetch(`${GAS_URL}?action=get_all`);
            allData = await resp.json();
            const body = document.getElementById('tableBody');
            body.innerHTML = "";

            for (const item of allData) {
                const row = document.createElement('tr');
                if(item.status === '承認済') row.className = "approved";
                
                // URLから情報をスクレイピング（簡易デモ用：実際にはGAS側で行うのが理想）
                row.innerHTML = `
                    <td>${item.user}</td>
                    <td>
                        <div class="url-data-info">
                            <strong>品名:</strong> ${item.itemName || '読み取り中...'} <br>
                            <strong>型式:</strong> ${item.model || '---'} | <strong>価格:</strong> ${item.price || 0}円<br>
                            <a href="${item.url}" target="_blank">商品URL</a>
                        </div>
                    </td>
                    <td><input type="number" value="${item.qty || 1}" id="qty-${item.row}" style="width:45px"></td>
                    <td>${item.status || '未'}</td>
                    <td>
                        <button style="background:#28a745; padding:5px;" onclick="approveWithScraping(${item.row}, '${item.url}')">取得&承認</button>
                        <button style="background:#6c757d; padding:5px;" onclick="updateItem(${item.row}, '却下')">却下</button>
                    </td>
                `;
                body.appendChild(row);
            }
            document.getElementById('status').innerText = "読込完了";
        } catch (e) { document.getElementById('status').innerText = "読込エラー"; }
    }

    // URLから情報を抽出して承認する機能
    async function approveWithScraping(row, url) {
        document.getElementById('status').innerText = "商品情報を解析中...";
        // 本来はCORS制限があるため、GAS側にURLを送って解析させるのが正解です
        // ここではGASのupdateアクションにURL解析も含める想定で構築します
        const qty = document.getElementById(`qty-${row}`).value;
        try {
            await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "approve_with_data", row: row, url: url, qty: qty })
            });
            loadItems();
        } catch (e) { alert("情報取得に失敗しました。GAS側の実装を確認してください。"); }
    }

    async function updateItem(row, status) {
        const qty = document.getElementById(`qty-${row}`).value;
        await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "update", row: row, status: status, qty: qty }) });
        loadItems();
    }

    function handleTemplateUpload(input, storageKey) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const buffer = e.target.result;
            if(storageKey === 'excel_template') cachedRequestTemplate = buffer;
            else cachedCatalogTemplate = buffer;
            localStorage.setItem(storageKey, arrayBufferToBase64(buffer));
            alert("テンプレートを保存しました。");
        };
        reader.readAsArrayBuffer(file);
    }

    // --- 発注依頼表 出力 ---
    async function exportFromTemplate() {
        if (!cachedRequestTemplate) return alert("テンプレ未設定");
        const prevTotal = prompt("これまでの支出合計", "0");
        const accountant = document.getElementById('accountantName').value || "未設定";

        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(cachedRequestTemplate);
        const sheet = workbook.getWorksheet('エネルギー研');

        // 【機能】書き込み範囲(A13:G22)をクリア
        for(let r=13; r<=22; r++) {
            for(let c=1; c<=7; c++) sheet.getRow(r).getCell(c).value = null;
        }

        const now = new Date();
        const dateStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`;
        sheet.getCell('F2').value = dateStr;
        sheet.getCell('F3').value = "会計担当　" + accountant;
        sheet.getCell('B8').value = Number(prevTotal);

        const approved = allData.filter(i => i.status === '承認済');
        approved.forEach((item, i) => {
            const r = 13 + i;
            if (r <= 22) {
                sheet.getCell(`A${r}`).value = dateStr;
                sheet.getCell(`C${r}`).value = item.itemName || "商品詳細はカタログ参照";
                sheet.getCell(`D${r}`).value = item.model || "";
                sheet.getCell(`E${r}`).value = Number(item.price) || 0;
                sheet.getCell(`F${r}`).value = Number(item.qty);
                sheet.getCell(`G${r}`).value = item.maker || "";
            }
        });

        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), `エネルギー研究会_発注依頼表_${now.getFullYear()}_${now.getMonth()+1}_${now.getDate()}.xlsx`);
    }

    // --- カタログ 出力 ---
    async function exportCatalog() {
        if (!cachedCatalogTemplate) return alert("テンプレ未設定");
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(cachedCatalogTemplate);
        const sheet = workbook.getWorksheet(1);

        // 【機能】書き込み範囲(C3:H16)をクリア
        for(let r=3; r<=16; r++) {
            for(let c=3; c<=8; c++) sheet.getRow(r).getCell(c).value = null;
        }

        const approved = allData.filter(i => i.status === '承認済');
        approved.forEach((item, i) => {
            const r = 3 + i;
            if (r <= 16) {
                sheet.getCell(`C${r}`).value = item.itemName || "";
                sheet.getCell(`D${r}`).value = item.model || "";
                sheet.getCell(`E${r}`).value = Number(item.price) || 0;
                sheet.getCell(`F${r}`).value = Number(item.qty);
                sheet.getCell(`G${r}`).value = item.maker || "";
                sheet.getCell(`H${r}`).value = item.url;
            }
        });

        const now = new Date();
        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), `エネルギー研究会_カタログURL_${now.getFullYear()}_${now.getMonth()+1}_${now.getDate()}.xlsx`);
    }

    function arrayBufferToBase64(buffer) {
        let binary = ''; const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
        return window.btoa(binary);
    }
    function base64ToArrayBuffer(base64) {
        const binary_string = window.atob(base64);
        const len = binary_string.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = binary_string.charCodeAt(i);
        return bytes.buffer;
    }
</script>
</body>
</html>