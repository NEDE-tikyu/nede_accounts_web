<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>エネルギー研究会 発注管理システム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; }
        .approved { color: green; font-weight: bold; background-color: #e9f7ef; }
        .btn-group { margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold; }
        .btn-load { background: #007bff; }
        .btn-excel { background: #28a745; }
        .btn-catalog { background: #17a2b8; }
        .btn-upload { background: #6f42c1; }
        .btn-upload-cat { background: #e83e8c; }
        #status { font-weight: bold; color: #555; padding: 10px; background: #eee; border-radius: 4px; }
        input[type="number"] { width: 50px; padding: 5px; }
        .section-title { margin-top: 20px; font-size: 0.9em; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h1>エネルギー研究会 発注管理画面</h1>
    <p id="status">ステータス: 準備完了</p>

    <div class="section-title">▼ 1. データ操作</div>
    <div class="btn-group">
        <button class="btn-load" onclick="loadItems()">データ読み込み</button>
    </div>

    <div class="section-title">▼ 2. テンプレート設定（初回のみ）</div>
    <div class="btn-group">
        <input type="file" id="templateInput" style="display:none" accept=".xlsx" onchange="handleTemplateUpload(this, 'excel_template')">
        <button class="btn-upload" onclick="document.getElementById('templateInput').click()">発注依頼表テンプレ更新</button>

        <input type="file" id="catalogInput" style="display:none" accept=".xlsx" onchange="handleTemplateUpload(this, 'catalog_template')">
        <button class="btn-upload-cat" onclick="document.getElementById('catalogInput').click()">カタログ用テンプレ更新</button>
    </div>

    <div class="section-title">▼ 3. 書類出力</div>
    <div class="btn-group">
        <button class="btn-excel" onclick="exportFromTemplate()">Excel出力 (発注依頼表)</button>
        <button class="btn-catalog" onclick="exportCatalog()">Excel出力 (カタログ)</button>
    </div>

    <table id="itemTable">
        <thead>
            <tr>
                <th>年度</th><th>投稿者</th><th>URL</th><th>個数</th><th>状態</th><th>操作</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    const GAS_URL = "あなたのGASデプロイURL"; 
    let allData = [];
    let cachedRequestTemplate = null;
    let cachedCatalogTemplate = null;

    window.onload = () => {
        const savedReq = localStorage.getItem('excel_template');
        if (savedReq) cachedRequestTemplate = base64ToArrayBuffer(savedReq);
        const savedCat = localStorage.getItem('catalog_template');
        if (savedCat) cachedCatalogTemplate = base64ToArrayBuffer(savedCat);
        
        if(savedReq && savedCat) document.getElementById('status').innerText = "全テンプレート読込済。";
    };

    async function loadItems() {
        document.getElementById('status').innerText = "読み込み中...";
        try {
            const resp = await fetch(`${GAS_URL}?action=get_all`);
            allData = await resp.json();
            const body = document.getElementById('tableBody');
            body.innerHTML = "";
            allData.forEach(item => {
                const isApproved = (item.status === '承認済');
                const row = document.createElement('tr');
                if(isApproved) row.className = "approved";
                row.innerHTML = `
                    <td>${item.year || ''}</td><td>${item.user || ''}</td>
                    <td><a href="${item.url}" target="_blank">リンク</a></td>
                    <td><input type="number" value="${item.qty || 1}" id="qty-${item.row}"></td>
                    <td>${item.status || '未承認'}</td>
                    <td>
                        <button style="background:#28a745" onclick="updateItem(${item.row}, '承認済')">承認</button>
                        <button style="background:#6c757d" onclick="updateItem(${item.row}, '却下')">却下</button>
                    </td>
                `;
                body.appendChild(row);
            });
            document.getElementById('status').innerText = "読込完了";
        } catch (e) { document.getElementById('status').innerText = "エラー: " + e; }
    }

    async function updateItem(row, status) {
        const qty = document.getElementById(`qty-${row}`).value;
        try {
            await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "update", row: row, status: status, qty: qty }) });
            loadItems();
        } catch (e) { alert("更新失敗"); }
    }

    function handleTemplateUpload(input, storageKey) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const buffer = e.target.result;
            if(storageKey === 'excel_template') cachedRequestTemplate = buffer;
            else cachedCatalogTemplate = buffer;
            localStorage.setItem(storageKey, arrayBufferToBase64(buffer));
            alert("テンプレートを保存しました。");
        };
        reader.readAsArrayBuffer(file);
    }

    // --- カタログ出力機能 ---
    async function exportCatalog() {
        if (!cachedCatalogTemplate) { alert("カタログ用テンプレートを先に更新してください。"); return; }
        try {
            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(cachedCatalogTemplate);
            const sheet = workbook.getWorksheet(1); // 1番目のシート

            const approvedItems = allData.filter(item => item.status === '承認済');
            approvedItems.forEach((item, index) => {
                const r = 3 + index; // 3行目から開始
                if (r <= 16) {
                    sheet.getCell(`C${r}`).value = "商品詳細はURL参照"; // 品名 (スプレッドシートに項目があれば item.name)
                    sheet.getCell(`F${r}`).value = Number(item.qty);
                    sheet.getCell(`H${r}`).value = item.url;
                }
            });

            const now = new Date();
            const fileName = `エネルギー研究会_カタログURL_${now.getFullYear()}_${now.getMonth()+1}_${now.getDate()}.xlsx`;
            const buffer = await workbook.xlsx.writeBuffer();
            saveAs(new Blob([buffer]), fileName);
        } catch (e) { alert("出力エラー"); }
    }

    // --- 発注依頼表出力機能（前回分） ---
    async function exportFromTemplate() {
        if (!cachedRequestTemplate) { alert("発注依頼表テンプレートを先に更新してください。"); return; }
        const previousTotal = prompt("支出金額合計を入力", "0");
        if (previousTotal === null) return;
        try {
            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(cachedRequestTemplate);
            const sheet = workbook.getWorksheet('エネルギー研');
            const now = new Date();
            const dateStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`;
            sheet.getCell('F2').value = dateStr;
            sheet.getCell('F3').value = "会計担当　三宅啓斗";
            sheet.getCell('B8').value = Number(previousTotal);
            const approvedItems = allData.filter(item => item.status === '承認済');
            approvedItems.forEach((item, index) => {
                const r = 13 + index;
                if (r <= 22) {
                    sheet.getCell(`A${r}`).value = dateStr;
                    sheet.getCell(`C${r}`).value = "詳細はカタログ参照";
                    sheet.getCell(`F${r}`).value = Number(item.qty);
                }
            });
            const fileName = `エネルギー研究会_発注依頼表_${now.getFullYear()}_${now.getMonth()+1}_${now.getDate()}.xlsx`;
            const buffer = await workbook.xlsx.writeBuffer();
            saveAs(new Blob([buffer]), fileName);
        } catch (e) { alert("出力エラー"); }
    }

    function arrayBufferToBase64(buffer) {
        let binary = ''; const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
        return window.btoa(binary);
    }
    function base64ToArrayBuffer(base64) {
        const binary_string = window.atob(base64);
        const len = binary_string.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = binary_string.charCodeAt(i);
        return bytes.buffer;
    }
</script>
</body>
</html>