<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¨ãƒãƒ«ã‚®ãƒ¼ç ”ç©¶ä¼š ç™ºæ³¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f7f6; line-height: 1.6; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .btn-group { margin: 15px 0; display: flex; gap: 8px; flex-wrap: wrap; }
        button { padding: 10px 16px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold; transition: 0.3s; }
        
        /* ãƒœã‚¿ãƒ³ã®è‰²è¨­å®š */
        .btn-load { background: #007bff; }
        .btn-excel { background: #28a745; }
        .btn-catalog { background: #17a2b8; }
        .btn-upload { background: #6f42c1; }
        .btn-upload-cat { background: #e83e8c; }
        .btn-save-name { background: #495057; }
        .btn-get { background: #007bff; padding: 5px 10px; }
        .btn-approve { background: #28a745; padding: 5px 10px; }
        
        /* ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—BOXï¼ˆè¿½åŠ ï¼‰ */
        .setup-area { background: #eef9ff; border: 2px dashed #007bff; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .bookmark-btn { display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 50px; font-weight: bold; cursor: move; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        #status { font-weight: bold; color: #d9534f; padding: 10px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f8f9fa; }
        .approved { background-color: #e9f7ef; }
        .input-area { background: #f1f3f5; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .url-data-info { font-size: 0.85em; color: #333; }
    </style>
</head>
<body>

<div class="container">
    <h1>ã‚¨ãƒãƒ«ã‚®ãƒ¼ç ”ç©¶ä¼š ç™ºæ³¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  PRO</h1>
    <p id="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æº–å‚™å®Œäº†</p>

    <div class="setup-area">
        <strong>ã€åˆå›è¨­å®šã€‘</strong> ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒãƒ¼ã«å¼•ããšã‚Šè¾¼ã‚“ã§ãã ã•ã„
        <br><br>
        <a id="bookmarkletLink" href="" class="bookmark-btn">ğŸ“¦ å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—</a>
    </div>

    <div class="input-area">
        <strong>ä¼šè¨ˆæ‹…å½“è€…å:</strong> 
        <input type="text" id="accountantName" placeholder="ä¸‰å®…å•“æ–—" style="padding: 8px; width: 200px;">
        <button class="btn-save-name" onclick="saveAccountantName()">åå‰ã‚’ä¿å­˜</button>
    </div>

    <div class="btn-group">
        <button class="btn-load" onclick="loadItems()">â‘  ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</button>
        <input type="file" id="templateInput" style="display:none" accept=".xlsx" onchange="handleTemplateUpload(this, 'excel_template')">
        <button class="btn-upload" onclick="document.getElementById('templateInput').click()">â‘¡ ç™ºæ³¨è¡¨ãƒ†ãƒ³ãƒ—ãƒ¬æ›´æ–°</button>
        <input type="file" id="catalogInput" style="display:none" accept=".xlsx" onchange="handleTemplateUpload(this, 'catalog_template')">
        <button class="btn-upload-cat" onclick="document.getElementById('catalogInput').click()">â‘¢ ã‚«ã‚¿ãƒ­ã‚°ãƒ†ãƒ³ãƒ—ãƒ¬æ›´æ–°</button>
    </div>

    <div class="btn-group">
        <button class="btn-excel" onclick="exportFromTemplate()">Excelå‡ºåŠ› (ç™ºæ³¨ä¾é ¼è¡¨)</button>
        <button class="btn-catalog" onclick="exportCatalog()">Excelå‡ºåŠ› (ã‚«ã‚¿ãƒ­ã‚°)</button>
    </div>

    <table id="itemTable">
        <thead>
            <tr>
                <th>æŠ•ç¨¿è€…</th><th>å•†å“è©³ç´° (ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‹ã‚‰å–å¾—)</th><th>å€‹æ•°</th><th>çŠ¶æ…‹</th><th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    // â˜…GASã®Webã‚¢ãƒ—ãƒªURLã‚’ã“ã“ã«è²¼ã£ã¦ãã ã•ã„
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzjXuIzxkZlxj6joJ-_sTWKHhVGnnhbNAOsfGpvV0DzroaQ5XpnOR7M41Sm54Q3N5v2/exec"; 

    let allData = [];
    let cachedRequestTemplate = null;
    let cachedCatalogTemplate = null;

    // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆå‹•çš„ã«GAS_URLã‚’åŸ‹ã‚è¾¼ã‚€ï¼‰
    const bml = `javascript:(function(){const gasUrl='${GAS_URL}';const fields=['å“å','å‹å¼','å˜ä¾¡','ãƒ¡ãƒ¼ã‚«ãƒ¼'];let results={};let currentStep=0;let lastText='';const panel=document.createElement('div');panel.style='position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:2147483647;background:#222;color:#00ffcc;padding:20px;border-radius:12px;font-family:sans-serif;box-shadow:0 10px 40px rgba(0,0,0,0.8);border:2px solid #00ffcc;text-align:center;min-width:300px;';document.body.appendChild(panel);const update=()=>{panel.innerHTML=\`<div style='font-size:12px;color:#888;'>STEP \${currentStep+1}/\${fields.length}</div><div style='font-size:20px;margin:10px 0;font-weight:bold;'>ã€Œ\${fields[currentStep]}ã€ã‚’é¸æŠã—ã¦Enter</div><div style='font-size:12px;color:#aaa;'>ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ç¯„å›²é¸æŠã—ã¦ç¢ºå®š</div>\`};const style=document.createElement('style');style.innerHTML='.gas-target{outline:2px solid #00ffcc !important;background:rgba(0,255,204,0.1) !important;}';document.head.appendChild(style);const onOver=(e)=>e.target.classList.add('gas-target');const onOut=(e)=>e.target.classList.remove('gas-target');const onClick=(e)=>{e.preventDefault();e.stopPropagation();lastText=e.target.innerText.trim()};document.addEventListener('mouseover',onOver);document.addEventListener('mouseout',onOut);document.addEventListener('click',onClick);const onKey=(e)=>{if(e.key==='Enter'){const sel=window.getSelection().toString().trim();results[fields[currentStep]]=sel||lastText;currentStep++;if(currentStep<fields.length){lastText='';update()}else{finish()}}};window.addEventListener('keydown',onKey);function finish(){panel.innerHTML='ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸é€ä¿¡ä¸­...';document.removeEventListener('mouseover',onOver);document.removeEventListener('mouseout',onOut);document.removeEventListener('click',onClick);window.removeEventListener('keydown',onKey);fetch(gasUrl,{method:'POST',mode:'no-cors',body:JSON.stringify({action:'update_from_browser',url:window.location.href,data:results})}).then(()=>{panel.style.background='#006633';panel.innerHTML='æ›´æ–°å®Œäº†ï¼ã“ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã¦OKã§ã™';setTimeout(()=>panel.remove(),2000)})};update()})();`;
    document.getElementById('bookmarkletLink').href = bml;

    window.onload = () => {
        const savedName = localStorage.getItem('accountant_name');
        if (savedName) document.getElementById('accountantName').value = savedName;
        const savedReq = localStorage.getItem('excel_template');
        if (savedReq) cachedRequestTemplate = base64ToArrayBuffer(savedReq);
        const savedCat = localStorage.getItem('catalog_template');
        if (savedCat) cachedCatalogTemplate = base64ToArrayBuffer(savedCat);
    };

    function saveAccountantName() {
        localStorage.setItem('accountant_name', document.getElementById('accountantName').value);
        alert("åå‰ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
    }

    async function loadItems() {
        document.getElementById('status').innerText = "èª­ã¿è¾¼ã¿ä¸­...";
        try {
            const resp = await fetch(`${GAS_URL}?action=get_all`);
            allData = await resp.json();
            const body = document.getElementById('tableBody');
            body.innerHTML = "";

            allData.reverse().forEach(item => {
                const row = document.createElement('tr');
                if(item.status === 'æ‰¿èªæ¸ˆ') row.className = "approved";
                
                row.innerHTML = `
                    <td>${item.user}</td>
                    <td>
                        <div class="url-data-info">
                            <strong>å“å:</strong> ${item.itemName || '-'} <br>
                            <strong>å‹å¼:</strong> ${item.model || '-'} | <strong>å˜ä¾¡:</strong> ${item.price || 0}å††<br>
                            <strong>URL:</strong> <a href="${item.url}" target="_blank">å•†å“ãƒšãƒ¼ã‚¸ã‚’é–‹ã</a>
                        </div>
                    </td>
                    <td><input type="number" value="${item.qty || 1}" id="qty-${item.row}" style="width:45px"></td>
                    <td><span style="font-size:12px">${item.status}</span></td>
                    <td>
                        <button class="btn-get" onclick="window.open('${item.url}', '_blank')">å–å¾—</button>
                        <button class="btn-approve" onclick="approveRow(${item.row})">æ‰¿èª</button>
                        <button style="background:#6c757d; padding:5px; margin-top:5px" onclick="updateItem(${item.row}, 'å´ä¸‹')">å´ä¸‹</button>
                    </td>
                `;
                body.appendChild(row);
            });
            document.getElementById('status').innerText = "èª­è¾¼å®Œäº†";
        } catch (e) { document.getElementById('status').innerText = "èª­è¾¼ã‚¨ãƒ©ãƒ¼"; }
    }

    async function approveRow(row) {
        const qty = document.getElementById(`qty-${row}`).value;
        document.getElementById('status').innerText = "æ›´æ–°ä¸­...";
        await fetch(GAS_URL, { 
            method: "POST", 
            body: JSON.stringify({ action: "update_status", row: row, status: "æ‰¿èªæ¸ˆ", qty: qty }) 
        });
        loadData();
    }

    async function updateItem(row, status) {
        const qty = document.getElementById(`qty-${row}`).value;
        await fetch(GAS_URL, { 
            method: "POST", 
            body: JSON.stringify({ action: "update", row: row, status: status, qty: qty }) 
        });
        loadItems();
    }

    // --- Excelç³»é–¢æ•°ï¼ˆæ—§ã‚³ãƒ¼ãƒ‰ãã®ã¾ã¾ï¼‰ ---
    function handleTemplateUpload(input, storageKey) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const buffer = e.target.result;
            if(storageKey === 'excel_template') cachedRequestTemplate = buffer;
            else cachedCatalogTemplate = buffer;
            localStorage.setItem(storageKey, arrayBufferToBase64(buffer));
            alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
        };
        reader.readAsArrayBuffer(file);
    }

    async function exportFromTemplate() {
        if (!cachedRequestTemplate) return alert("ãƒ†ãƒ³ãƒ—ãƒ¬æœªè¨­å®š");
        const prevTotal = prompt("ã“ã‚Œã¾ã§ã®æ”¯å‡ºåˆè¨ˆ", "0");
        const accountant = document.getElementById('accountantName').value || "æœªè¨­å®š";
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(cachedRequestTemplate);
        const sheet = workbook.getWorksheet('ã‚¨ãƒãƒ«ã‚®ãƒ¼ç ”');
        const approved = allData.filter(i => i.status === 'æ‰¿èªæ¸ˆ');
        
        const now = new Date();
        const dateStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`;
        sheet.getCell('F2').value = dateStr;
        sheet.getCell('F3').value = "ä¼šè¨ˆæ‹…å½“ã€€" + accountant;
        sheet.getCell('B8').value = Number(prevTotal);

        approved.slice(0, 10).forEach((item, i) => {
            const r = 13 + i;
            sheet.getCell(`A${r}`).value = dateStr;
            sheet.getCell(`C${r}`).value = item.itemName;
            sheet.getCell(`D${r}`).value = item.model;
            sheet.getCell(`E${r}`).value = Number(item.price);
            sheet.getCell(`F${r}`).value = Number(item.qty);
            sheet.getCell(`G${r}`).value = item.maker;
        });
        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), `ç™ºæ³¨ä¾é ¼è¡¨_${dateStr}.xlsx`);
    }

    async function exportCatalog() {
        if (!cachedCatalogTemplate) return alert("ãƒ†ãƒ³ãƒ—ãƒ¬æœªè¨­å®š");
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(cachedCatalogTemplate);
        const sheet = workbook.getWorksheet(1);
        const approved = allData.filter(i => i.status === 'æ‰¿èªæ¸ˆ');
        approved.slice(0, 14).forEach((item, i) => {
            const r = 3 + i;
            sheet.getCell(`C${r}`).value = item.itemName;
            sheet.getCell(`D${r}`).value = item.model;
            sheet.getCell(`E${r}`).value = Number(item.price);
            sheet.getCell(`F${r}`).value = Number(item.qty);
            sheet.getCell(`G${r}`).value = item.maker;
            sheet.getCell(`H${r}`).value = item.url;
        });
        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), `ã‚«ã‚¿ãƒ­ã‚°_${new Date().toLocaleDateString()}.xlsx`);
    }

    function arrayBufferToBase64(buffer) {
        let binary = ''; const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
        return window.btoa(binary);
    }
    function base64ToArrayBuffer(base64) {
        const binary_string = window.atob(base64);
        const len = binary_string.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = binary_string.charCodeAt(i);
        return bytes.buffer;
    }
</script>
</body>
</html>