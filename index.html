<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>エネルギー研究会 発注承認システム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f7f6; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; }
        .approved { color: green; font-weight: bold; background-color: #e9f7ef; }
        .btn-group { margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: bold; }
        .btn-load { background: #007bff; }
        .btn-excel { background: #28a745; }
        .btn-pdf { background: #dc3545; }
        .btn-upload { background: #6f42c1; }
        #status { font-weight: bold; color: #555; padding: 10px; background: #eee; border-radius: 4px; }
        input[type="number"] { width: 50px; padding: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>エネルギー研究会 発注管理画面</h1>
    <p id="status">ステータス: 準備完了。テンプレートをアップロードしてください。</p>

    <div class="btn-group">
        <button class="btn-load" onclick="loadItems()">① データ読み込み</button>
        
        <input type="file" id="templateInput" style="display:none" accept=".xlsx" onchange="handleTemplateUpload(this)">
        <button class="btn-upload" onclick="document.getElementById('templateInput').click()">② テンプレート更新</button>
        
        <button class="btn-excel" onclick="exportFromTemplate()">③ Excel出力 (エネルギー研)</button>
        <button class="btn-pdf" onclick="exportToPDF()">④ PDF出力 (カタログ)</button>
    </div>

    <table id="itemTable">
        <thead>
            <tr>
                <th>年度</th>
                <th>投稿者</th>
                <th>URL</th>
                <th>個数</th>
                <th>状態</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
    </table>
</div>

<script>
    // --- 設定：あなたのGAS URLをここに貼り付けてください ---
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyRYNgvBWNmA5KjlXhcPFaP1vzWOO1O5ErfJE8Sptqg39RelF7tjxlnEfNcy16s1nCRaw/exec"; 
    
    let allData = [];
    let cachedTemplate = null;

    // ページ読み込み時にブラウザ保存されたテンプレを復元
    window.onload = () => {
        const saved = localStorage.getItem('excel_template');
        if (saved) {
            cachedTemplate = base64ToArrayBuffer(saved);
            document.getElementById('status').innerText = "保存済みテンプレートを読み込みました。";
        }
    };

    // 1. スプレッドシートからデータ取得
    async function loadItems() {
        document.getElementById('status').innerText = "読み込み中...";
        try {
            const resp = await fetch(`${GAS_URL}?action=get_all`);
            allData = await resp.json();
            const body = document.getElementById('tableBody');
            body.innerHTML = "";

            allData.forEach(item => {
                const isApproved = (item.status === '承認済');
                const row = document.createElement('tr');
                if(isApproved) row.className = "approved";
                
                row.innerHTML = `
                    <td>${item.year || ''}</td>
                    <td>${item.user || ''}</td>
                    <td><a href="${item.url}" target="_blank">商品リンク</a></td>
                    <td><input type="number" value="${item.qty || 1}" id="qty-${item.row}"></td>
                    <td>${item.status || '未承認'}</td>
                    <td>
                        <button style="background:#28a745" onclick="updateItem(${item.row}, '承認済')">承認</button>
                        <button style="background:#6c757d" onclick="updateItem(${item.row}, '却下')">却下</button>
                    </td>
                `;
                body.appendChild(row);
            });
            document.getElementById('status').innerText = "データの読み込みが完了しました。";
        } catch (e) {
            document.getElementById('status').innerText = "エラー: " + e;
        }
    }

    // 2. 状態更新（承認/却下）
    async function updateItem(row, status) {
        const qty = document.getElementById(`qty-${row}`).value;
        document.getElementById('status').innerText = "送信中...";
        try {
            await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "update", row: row, status: status, qty: qty })
            });
            loadItems(); // 一覧を再読込
        } catch (e) {
            alert("更新に失敗しました。");
        }
    }

    // 3. テンプレートのアップロードと保存
    function handleTemplateUpload(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            cachedTemplate = e.target.result;
            // ブラウザのLocalStorageに保存（Base64形式）
            localStorage.setItem('excel_template', arrayBufferToBase64(cachedTemplate));
            document.getElementById('status').innerText = "テンプレートを更新し、ブラウザに保存しました。";
            alert("テンプレートの更新完了！");
        };
        reader.readAsArrayBuffer(file);
    }

    // 4. Excel出力 (テンプレートの他シートを保持したまま「エネルギー研」を編集)
    async function exportFromTemplate() {
        if (!cachedTemplate) {
            alert("先に「テンプレート更新」ボタンからファイルを読み込ませてください。");
            return;
        }

        const previousTotal = prompt("これまでの支出金額合計を入力してください", "272715");
        if (previousTotal === null) return;

        try {
            document.getElementById('status').innerText = "Excel生成中...";
            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(cachedTemplate);

            // 他のシートを保持したまま「エネルギー研」シートのみ取得
            const sheet = workbook.getWorksheet('エネルギー研');
            if (!sheet) {
                alert("シート「エネルギー研」が見つかりません。");
                return;
            }

            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const date = now.getDate();
            const dateStr = `${year}/${month}/${date}`;

            // 指定されたセルに書き込み
            sheet.getCell('F2').value = dateStr;
            sheet.getCell('F3').value = "会計担当　三宅啓斗";
            sheet.getCell('B8').value = Number(previousTotal);

            // 承認済みデータを13行目から反映
            const approvedItems = allData.filter(item => item.status === '承認済');
            approvedItems.forEach((item, index) => {
                const r = 13 + index;
                if (r <= 22) { // 枠内のみ
                    sheet.getCell(`A${r}`).value = dateStr;
                    sheet.getCell(`C${r}`).value = "詳細はカタログURL参照";
                    sheet.getCell(`F${r}`).value = Number(item.qty);
                }
            });

            // ファイル名：エネルギー研究会_発注依頼表_年度_月_日付
            const fileName = `エネルギー研究会_発注依頼表_${year}_${month}_${date}.xlsx`;

            const buffer = await workbook.xlsx.writeBuffer();
            saveAs(new Blob([buffer]), fileName);
            document.getElementById('status').innerText = "Excelファイルを出力しました。";
        } catch (e) {
            console.error(e);
            alert("Excel出力中にエラーが発生しました。");
        }
    }

    // 5. PDF出力 (カタログ形式)
    function exportToPDF() {
        const approvedItems = allData.filter(item => item.status === '承認済');
        const element = document.createElement('div');
        element.style.padding = "20px";
        element.innerHTML = `
            <h1 style="text-align:center">カタログURLリスト (エネルギー研究会)</h1>
            <p style="text-align:right">作成日: ${new Date().toLocaleDateString()}</p>
            <table border="1" style="width:100%; border-collapse:collapse;">
                <tr style="background:#eee"><th>投稿者</th><th>商品URL</th><th>個数</th></tr>
                ${approvedItems.map(item => `
                    <tr>
                        <td style="padding:8px">${item.user}</td>
                        <td style="padding:8px; word-break:break-all">${item.url}</td>
                        <td style="padding:8px">${item.qty}</td>
                    </tr>
                `).join('')}
            </table>
        `;
        html2pdf().set({ margin: 10, filename: 'カタログURLリスト.pdf' }).from(element).save();
    }

    // --- 補助関数 ---
    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
        return window.btoa(binary);
    }
    function base64ToArrayBuffer(base64) {
        const binary_string = window.atob(base64);
        const len = binary_string.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = binary_string.charCodeAt(i);
        return bytes.buffer;
    }
</script>

</body>
</html>